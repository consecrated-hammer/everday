services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - VITE_API_BASE_URL=/api
        - VITE_APP_VERSION=${VITE_APP_VERSION}
        - VITE_BUILD_TIME=${VITE_BUILD_TIME}
        - VITE_IMAGE_TAG=${VITE_IMAGE_TAG:-dev}
        - VITE_BUILD_ENV=development
        - VITE_COMMIT_SHA=${VITE_COMMIT_SHA}
    container_name: everday-dev
    environment:
      TZ: Australia/Adelaide
    restart: unless-stopped
    env_file: .env.dev
    volumes:
      - ./backend/logs:/app/logs
      - ./backend/uploads:/app/app/static/uploads
      - ${DOCUMENT_STORAGE_HOST_PATH:-./backend/document_storage}:/app/data/documents
    networks:
      - traefik_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_proxy"
      - "traefik.http.routers.everday-dev.rule=Host(`${EVERDAY_DEV_HOST:-everday-dev.batserver.au}`) || Host(`www.${EVERDAY_DEV_HOST:-everday-dev.batserver.au}`)"
      - "traefik.http.routers.everday-dev.entrypoints=websecure"
      - "traefik.http.routers.everday-dev.tls.certresolver=letsencrypt"
      - "traefik.http.services.everday-dev.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.everday-dev-sec.headers.customResponseHeaders.X-Content-Type-Options=nosniff"
      - "traefik.http.middlewares.everday-dev-sec.headers.customResponseHeaders.X-Frame-Options=SAMEORIGIN"
      - "traefik.http.routers.everday-dev.middlewares=everday-dev-sec"
      - "homepage.enable=true"
      - "homepage.name=Everday Dev"
      - "homepage.href=https://${EVERDAY_DEV_HOST:-everday-dev.batserver.au}"
      - "homepage.icon=https://${EVERDAY_DEV_HOST:-everday-dev.batserver.au}/favicon.svg"
      - "homepage.group=Projects"
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  traefik_proxy:
    external: true
    name: traefik_proxy
